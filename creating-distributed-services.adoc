= 分散サービスの作成
:experimental:

このラボでは、サンプルアプリケーションをシステムにインストールします。このアプリケーションはIstioの様々な側面をデモするためにIstio自体に含まれていますが、このアプリケーションはIstioだけに縛られているわけではなく、Istioの有無に関わらず任意のOpenShiftインスタンスにインストールできる普通のマイクロサービスアプリケーションです。

サンプルアプリケーションは _Bookinfo_ と呼ばれるもので、オンライン書店のカタログのような本の情報を表示するシンプルなアプリケーションです。ページには、本の説明、本の詳細（ISBN、ページ数など）、書評が表示されます。

BookInfo アプリケーションは、4 つの独立したマイクロサービスに分かれています:

<1> *productpage* - `productpage` マイクロサービスは `details` と `reviews` マイクロサービスを呼び出してページを作成します。
<2> *details* - `details` マイクロサービスは本の情報を含みます。
<3> *reviews* - `reviews` マイクロサービスは書評を含みます。また、`ratings` マイクロサービスを呼び出して、それぞれの本の星の評価を表示します。
<4> *ratings* - `ratings` マイクロサービスは書評に付随する書籍の評価情報を含みます。

reviewsマイクロサービスには3つのバージョンがあります:

<1> バージョン `v1` はレーティングサービスを呼び出しません。
<2> バージョン `v2` はレーティングサービスを呼び出し、各レーティングを1〜5個の *黒* 星で表示します。
<3> バージョン `v3` はレーティングサービスを呼び出し、各レーティングを1〜5個の *赤* 星で表示します。

アプリケーションのアーキテクチャを以下の図で説明します:

image::istio_bookinfo.png[Bookinfo Architecture, 700]

=== 1. Bookinfoアプリケーションのデプロイ

First, open a new browser with the link:{{ CONSOLE_URL }}[OpenShift web console^]
まず、リンク先の {{ CONSOLE_URL }}[OpenShift web console^] で新しいブラウザを開きます。

image::openshift_login.png[openshift_login, 700]

以下でログインします:

* Username: `{{ USER_ID }}`
* Password: `{{ OPENSHIFT_USER_PASSWORD }}`

アクセスできるプロジェクトのリストが表示されます:

image::openshift_landing.png[openshift_landing, 700]

ランディングページに表示されるプロジェクトは、今日実行するラボによって異なります。 `Service Mesh and Identity` を開発する場合は、上の画像のようにあらかじめ作成されたプロジェクトが表示されます。

CodeReadyワークスペースはKubernetesクラスタ上で実行されていますが、デフォルトの制限付き _Service Account_ で実行されているため、ほとんどのリソースタイプを作成することができません。他のモジュールを完了している場合は、おそらくすでにログインしていると思いますが、もう一度ログインしてみましょう: *Login to OpenShift* をクリックして、与えられたクレデンシャルを入力します:

* Username: `{{ USER_ID }}`
* Password: `{{ OPENSHIFT_USER_PASSWORD }}`

image::cmd-login.png[login,700]

このようなものが表示されるはずです（プロジェクト名が異なる場合があります）:

[source,none]
----
Login successful.

You have access to the following projects and can switch between them with 'oc project <projectname>':

  * {{ USER_ID }}-bookinfo
    {{ USER_ID }}-catalog
    {{ USER_ID }}-cloudnative-pipeline
    {{ USER_ID }}-cloudnativeapps
    {{ USER_ID }}-inventory
    {{ USER_ID }}-istio-system

Using project "{{ USER_ID }}-bookinfo".
Welcome! See 'oc help' to get started.
----

[NOTE]
====
After you log in using *Login to OpenShift*, the terminal is no longer usable as a regular terminal. You can close the terminal window. You will still be logged in when you open more terminals later!
*OpenShiftへのログイン* でログインした後は、通常のターミナルとして使用できなくなります。ターミナルのウィンドウを閉じることができます。後からさらに端末を開いてもログインしたままになります。
====

#####  ServiceMeshMemberRoll
アプリケーションをデプロイする前に、異なるアプリケーションのネームスペースに正しくアクセスできることを確認する必要があります。_Elasticsearch_, _Jaeger_, _Kiali_, _Service Mesh Operators_ を含む _ServiceMeshControlPlane_ は全てクラスタのプロビジョニング時にインストールされています。しかし、アプリケーションが異なるネームスペースをまたいで通信するためには、_ServiceMeshMemberRoll_ も作成されていることを確認する必要があります。

_ServiceMeshMemberRoll_ を作成しましょう。

- openshiftコンソールへのログイン link:{{CONSOLE_URL}}[OpenShift web console^]
- 画像のように右上隅のプラス記号を押します。

image::plussigntop_ocpconsole.png[Run yaml in console, 700]

- 図のように左上の名前空間 `{{ USER_ID }}-istio-system` を選択し、以下の _ServiceMeshMemberRoll_ YAML コードをエディタに貼り付けてください。

[source, yaml, role="copypaste"]
----
apiVersion: maistra.io/v1
kind: ServiceMeshMemberRoll
metadata:
  name: default
  namespace: {{ USER_ID }}-istio-system <1>
spec:
  members:
    - {{ USER_ID }}-bookinfo <2>
    - {{ USER_ID }}-catalog
    - {{ USER_ID }}-inventory
----
<1> は、_ServiceMeshMemberRoll_ とその他のサービスメッシュ関連オブジェクトを保持する istio-system 名前空間です。
<2> はこの _ServiceMesh_ の一部となるプロジェクトのリストです。このケースではアプリケーションは3つの名前空間(プロジェクト)にまたがっています。

image::smmr_yaml_create.png[Run yaml in console, 700]

- Create**をクリックします。これで必要な _ServiceMeshMemberRoll_ が作成されます。

おめでとうございます! これで新しいサービスメッシュのデプロイ先プロジェクト `{{ USER_ID }}-istio-system` に _ServiceMeshMemberRoll_ を作成することに成功しました。
それでは、アプリケーションをサービスメッシュにデプロイしていきましょう。

##### BookInfoアプリのデプロイ

CodeReady Workspaces経由でターミナルを開き、以下のコマンドを実行してbookinfoアプリをデプロイします:

[source,shell, role="copypaste"]
----
oc apply -n {{ USER_ID}}-bookinfo -f /projects/cloud-native-workshop-v2m3-labs/istio/bookinfo.yaml
----

そして、Bookinfo用の_ingress gateway_を作成します:

[source,shell, role="copypaste"]
----
oc apply -n {{ USER_ID}}-bookinfo -f /projects/cloud-native-workshop-v2m3-labs/istio/bookinfo-gateway.yaml
----

上記のデフォルトのingressは、任意の着信ホストのトラフィックを管理しますが、自分のingress宛のトラフィックだけを管理したいので、このコマンドでホストを'*'から特定のホストに変更してください:

[source,sh,role="copypaste"]
----
oc patch -n {{USER_ID}}-bookinfo virtualservice/bookinfo --type='json' -p '[{"op":"add","path":"/spec/hosts","value": ["istio-ingressgateway-{{USER_ID}}-istio-system.{{ROUTE_SUBDOMAIN}}"]}]'
----

最後に、デフォルトのデスティネーションルールを追加します (これはリクエストのルーティングに影響を与えるために後で変更します)。

[source,shell, role="copypaste"]
----
oc apply -n {{ USER_ID}}-bookinfo -f /projects/cloud-native-workshop-v2m3-labs/istio/destination-rule-all.yaml
----

利用可能なすべてのデスティネーションルールをリストアップします:

[source,shell, role="copypaste"]
----
oc get -n {{ USER_ID}}-bookinfo destinationrules
----

アプリがインストールされると、各Podは前述のように追加の _sidecar_ コンテナを取得します。

アプリで使用されている異なる言語/フレームワークに対応するために、いくつかの素敵なラベルを追加します:

[source,sh,role="copypaste"]
----
oc project {{USER_ID}}-bookinfo && \
oc label deployment/productpage-v1 app.openshift.io/runtime=python --overwrite && \
oc label deployment/details-v1 app.openshift.io/runtime=ruby --overwrite && \
oc label deployment/reviews-v1 app.openshift.io/runtime=java --overwrite && \
oc label deployment/reviews-v2 app.openshift.io/runtime=java --overwrite && \
oc label deployment/reviews-v3 app.openshift.io/runtime=java --overwrite && \
oc label deployment/ratings-v1 app.openshift.io/runtime=nodejs --overwrite && \
oc label deployment details-v1 app.kubernetes.io/part-of=bookinfo --overwrite && \
oc label deployment productpage-v1 app.kubernetes.io/part-of=bookinfo --overwrite && \
oc label deployment ratings-v1 app.kubernetes.io/part-of=bookinfo --overwrite && \
oc label deployment reviews-v1 app.kubernetes.io/part-of=bookinfo --overwrite && \
oc label deployment reviews-v2 app.kubernetes.io/part-of=bookinfo --overwrite && \
oc label deployment reviews-v3 app.kubernetes.io/part-of=bookinfo --overwrite && \
oc annotate deployment productpage-v1 app.openshift.io/connects-to=reviews-v1,reviews-v2,reviews-v3,details-v1 && \
oc annotate deployment reviews-v2 app.openshift.io/connects-to=ratings-v1 && \
oc annotate deployment reviews-v3 app.openshift.io/connects-to=ratings-v1
----

Let’s wait for our application to finish deploying. Go to the {{ CONSOLE_URL }}/topology/ns/{{ USER_ID }}-bookinfo[Topology View^] for the `{{USER_ID}}-bookinfo` project. You'll see the app components spinning up:
アプリケーションのデプロイが終わるのを待ちましょう。プロジェクトの {{{ CONSOLE_URL }}/topology/ns/{{ USER_ID }}-bookinfo[Topology View^] に移動します。アプリのコンポーネントが起動中であることがわかります:

image::bookinfo_topology.png[Bookinfo App, 700]

各コンポーネントが完全な青丸になるのを待ちます。
または、以下のコマンドを実行してデプロイが完了して `successfully rolled out` の結果が出るのを待つこともできます:

[source,shell,role="copypaste"]
----
 oc rollout status -n {{ USER_ID}}-bookinfo -w deployment/productpage-v1 && \
 oc rollout status -n {{ USER_ID}}-bookinfo -w deployment/reviews-v1 && \
 oc rollout status -n {{ USER_ID}}-bookinfo -w deployment/reviews-v2 && \
 oc rollout status -n {{ USER_ID}}-bookinfo -w deployment/reviews-v3 && \
 oc rollout status -n {{ USER_ID}}-bookinfo -w deployment/details-v1 && \
 oc rollout status -n {{ USER_ID}}-bookinfo -w deployment/ratings-v1
----

最後に、http://istio-ingressgateway-{{ USER_ID }}-istio-system.{{ ROUTE_SUBDOMAIN}}/productpage[Bookinfo Product Page^]にアクセスします。以下のようになっているはずです:

image::bookinfo.png[Bookinfo App, 700]

ページを複数回リロードしてください。レビューサービスの3つの異なるバージョンでは、星の表示が異なります - _v1_ では星が全く表示されず、 _v2_ では黒い星が表示され、 _v3_ では赤い星が表示されます:

* *v1*

image::stars-none.png[no stars, 700, 700]

* *v2*

image::stars-black.png[black stars, 700]

* *v3*:

image::stars-red.png[red stars, 700]

それは、レビューサービスには3つのバージョンのレビューのデプロイがあるからです。Istio のロードバランサーは _round-robin_ アルゴリズムを使用して、このサービスの 3 つのインスタンスを反復処理しています。

これでOpenShiftのPodを実行して、それぞれのPodにマイクロサービスと並んで _Envoyのサイドカー_ があるはずです。マイクロサービスは productpage、details、reviewsです。レビューマイクロサービスには3つのバージョンがあることに注意してください:

[source,shell, role="copypaste"]
----
oc get pods -n {{ USER_ID}}-bookinfo --selector app=reviews
----

上記コマンドの出力は、ポッド名が異なるため、似ているはずですが、完全に同じではありません。

[source,sh]
----
NAME                          READY   STATUS    RESTARTS   AGE
reviews-v1-7754bbd88-dm4s5    2/2     Running   0          12m
reviews-v2-69fd995884-qpddl   2/2     Running   0          12m
reviews-v3-5f9d5bbd8-sz29k    2/2     Running   0          12m
----

各マイクロサービスには、各サービスのために *2/2* コンテナが用意されていることに注目してください(1つはサービス用、もう1つはサイドカー用)。

アプリケーションがデプロイされ、Istioサービスメッシュにリンクされたので、アプリケーションコード自体に触れることなく、すぐに得られる価値を見てみましょう！ 

*おめでとうございます!* これで、OpenShift Service Mesh内に最初のアプリケーションが正常にデプロイされました。次のラボ _Service Visulization and Montioring_ に移りましょう。